// app/api/route.js
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { google } from "googleapis";

/* ----------------------------- ENV / CONFIG ----------------------------- */

const env = (k) => String(process.env[k] || "").trim().replace(/^['"]|['"]$/g, "");
const SHEET_ID = env("GOOGLE_SHEET_ID");
const CLIENT_EMAIL = env("GOOGLE_CLIENT_EMAIL");
const PRIVATE_KEY_RAW = env("GOOGLE_PRIVATE_KEY");
const PRIVATE_KEY = PRIVATE_KEY_RAW ? PRIVATE_KEY_RAW.replace(/\\n/g, "\n") : "";

const WEBHOOKS = {
  FACTURATION: env("WEBHOOK_FACTURATION"),
  CONVOCATION: env("WEBHOOK_CONVOCATION"),
  AVERTISSEMENT: env("WEBHOOK_AVERTISSEMENT"),
  LICENCIEMENT: env("WEBHOOK_LICENCIEMENT"),
  DEMISSION: env("WEBHOOK_DEMISSION"),
  RECRUTEMENT: env("WEBHOOK_RECRUTEMENT"),
  DEPENSE: env("WEBHOOK_DEPENSE"),
};

// UI / options (si tu veux, tu peux aussi les passer en ENV)
const UI_CONFIG = {
  adminPin: env("ADMIN_PIN") || "",
  discordUsername: env("DISCORD_USERNAME") || "Secretaire Vespucci",
  discordAvatarUrl: env("DISCORD_AVATAR_URL") || "",
  currencySymbol: env("CURRENCY_SYMBOL") || "$",
  currencyCode: env("CURRENCY_CODE") || "USD",
};

/* -------------------- CATALOGUE + ENTREPRISES EN DUR -------------------- */
/* ➜ Remplace/complète avec TES vrais produits & prix */
const HARDCODED_CATALOGUE = [
  { category: "Coiffure", product: "Coupe", price: 250 },
  { category: "Coiffure", product: "Coupe + Barbe", price: 350 },
  { category: "Coiffure", product: "Coloration", price: 600 },
  { category: "Tatouage", product: "Petit tattoo", price: 800 },
  { category: "Tatouage", product: "Moyen tattoo", price: 1500 },
  { category: "Esthétique", product: "Soin visage", price: 400 },
];

/* ➜ Remplace/complète avec TES entreprises + remises */
const HARDCODED_ENTERPRISES = [
  { name: "LSPD", discount: 10, phone: "", image: "" },
  { name: "EMS", discount: 10, phone: "", image: "" },
  { name: "Gouvernement", discount: 15, phone: "", image: "" },
];

/* ----------------------------- SMALL HELPERS ---------------------------- */

const normHeader = (s) =>
  String(s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "");

const normTitle = (s) =>
  String(s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");

const toNumber = (v) => {
  if (v === null || v === undefined) return 0;
  // gère "74%", "10 000$", "1,5", etc.
  const s = String(v)
    .replace(/[%$€£]/g, "")
    .replace(/\s+/g, "")
    .replace(",", ".")
    .replace(/[^0-9.\-]/g, "")
    .trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
};

const toBool = (v) => {
  const s = String(v ?? "").trim().toLowerCase();
  return s === "1" || s === "true" || s === "oui" || s === "yes";
};

const todayFR = () => new Date().toLocaleDateString("fr-FR");
const isoNow = () => new Date().toISOString();
const makeDepenseId = () => `DEP-${String(Math.floor(Date.now() / 1000)).slice(-6)}`;

async function readJson(req) {
  try {
    return await req.json();
  } catch {
    return {};
  }
}

function ok(data) {
  return NextResponse.json({ success: true, ...data });
}
function bad(message, status = 400, extra = undefined) {
  return NextResponse.json(
    { success: false, error: message, ...(extra ? { extra } : {}) },
    { status }
  );
}

async function sendDiscordWebhook(url, payload) {
  if (!url) return;
  try {
    await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  } catch (e) {
    console.error("Discord webhook error:", e?.message || e);
  }
}

/* ------------------------------ SHEETS AUTH ----------------------------- */

async function getSheets() {
  if (!SHEET_ID || !CLIENT_EMAIL || !PRIVATE_KEY) {
    throw new Error("ENV manquantes: GOOGLE_SHEET_ID / GOOGLE_CLIENT_EMAIL / GOOGLE_PRIVATE_KEY");
  }

  const auth = new google.auth.JWT(CLIENT_EMAIL, null, PRIVATE_KEY, [
    "https://www.googleapis.com/auth/spreadsheets",
  ]);

  return google.sheets({ version: "v4", auth });
}

function makeSheetCtx(sheets) {
  let cachedTitles = null;

  async function getTitles() {
    if (cachedTitles) return cachedTitles;
    const ss = await sheets.spreadsheets.get({ spreadsheetId: SHEET_ID });
    cachedTitles = (ss.data.sheets || [])
      .map((s) => s.properties?.title)
      .filter(Boolean);
    return cachedTitles;
  }

  async function resolveTab(candidates) {
    const titles = await getTitles();
    const map = new Map(titles.map((t) => [normTitle(t), t]));
    for (const c of candidates) {
      const found = map.get(normTitle(c));
      if (found) return found;
    }
    throw new Error(
      `Onglet introuvable. Tentés: ${candidates.join(", ")} | Disponibles: ${titles.join(", ")}`
    );
  }

  async function ensureTab(title) {
    const titles = await getTitles();
    if (titles.includes(title)) return;

    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SHEET_ID,
      requestBody: { requests: [{ addSheet: { properties: { title } } }] },
    });

    // update cache
    cachedTitles = [...titles, title];
  }

  return { getTitles, resolveTab, ensureTab };
}

async function getValues(sheets, tabName, rangeA1) {
  const res = await sheets.spreadsheets.values.get({
    spreadsheetId: SHEET_ID,
    range: `'${tabName}'!${rangeA1}`,
    valueRenderOption: "UNFORMATTED_VALUE",
  });
  return res.data.values || [];
}

/* ------------------------- TABLE PARSING (ROBUST) ------------------------ */

function findHeaderRow(values, requiredHeaders = []) {
  const req = requiredHeaders.map(normHeader).filter(Boolean);
  if (req.length === 0) return 0;

  let bestIdx = 0;
  let bestScore = -1;

  const maxScan = Math.min(values.length, 25);
  for (let i = 0; i < maxScan; i++) {
    const row = values[i] || [];
    const cols = row.map(normHeader);
    const score = req.reduce((s, h) => (cols.includes(h) ? s + 1 : s), 0);
    if (score > bestScore) {
      bestScore = score;
      bestIdx = i;
    }
  }
  return bestScore <= 0 ? 0 : bestIdx;
}

function tableFromAt(values, headerRowIndex = 0) {
  const rows = values || [];
  if (rows.length < headerRowIndex + 2) return [];

  const headerRow = rows[headerRowIndex] || [];
  const cols = [];

  for (let i = 0; i < headerRow.length; i++) {
    const h = normHeader(headerRow[i]);
    if (!h) continue; // ignore colonnes vides (ex: col A vide)
    cols.push({ key: h, idx: i });
  }

  const items = [];
  for (let r = headerRowIndex + 1; r < rows.length; r++) {
    const row = rows[r] || [];
    const obj = {};
    for (const c of cols) obj[c.key] = row[c.idx];

    const hasAny = Object.values(obj).some((x) => String(x ?? "").trim() !== "");
    if (hasAny) items.push(obj);
  }

  return items;
}

function tableFromAuto(values, requiredHeaders) {
  const headerIdx = findHeaderRow(values, requiredHeaders);
  return tableFromAt(values, headerIdx);
}

/* ---------------------------- OUTPUT HELPERS ---------------------------- */

async function ensureHeadersIfEmpty(sheets, ctx, sheetName, headers) {
  await ctx.ensureTab(sheetName);

  const check = await sheets.spreadsheets.values.get({
    spreadsheetId: SHEET_ID,
    range: `'${sheetName}'!A1:Z1`,
    valueRenderOption: "UNFORMATTED_VALUE",
  });

  const firstRow = check.data.values?.[0] || [];
  const hasAny = firstRow.some((x) => String(x ?? "").trim() !== "");
  if (hasAny) return;

  const endCol = String.fromCharCode(64 + headers.length); // A..Z
  await sheets.spreadsheets.values.update({
    spreadsheetId: SHEET_ID,
    range: `'${sheetName}'!A1:${endCol}1`,
    valueInputOption: "RAW",
    requestBody: { values: [headers] },
  });
}

/* ---------------------------- DATA LOADERS ----------------------------- */

async function loadRoleConfig(sheets, ctx) {
  const tab = await ctx.resolveTab(["Config", "CONFIG"]);
  const values = await getValues(sheets, tab, "A1:Z500");

  // Ton header est en ligne 2, on le détecte avec "poste" + "remise"
  const rows = tableFromAuto(values, ["poste", "remise"]);

  const discountByRole = {};
  const salaryMaxByRole = {};

  for (const r of rows) {
    const role = String(r.poste ?? r.role ?? "").trim();
    if (!role) continue;

    const discount = toNumber(r.remise ?? r.discount ?? 0);
    const salaryMax = toNumber(r.salaire_max ?? r.salaire ?? r.max ?? 0);

    discountByRole[role] = discount;
    salaryMaxByRole[role] = salaryMax;
  }

  return { discountByRole, salaryMaxByRole };
}

async function loadEmployees(sheets, ctx, discountByRole) {
  // Chez toi c'est "Comptabilité"
  const tab = await ctx.resolveTab(["Comptabilité", "Comptabilite", "COMPTABILITE", "Compta"]);
  const values = await getValues(sheets, tab, "A1:Z5000");

  // Header ligne 1 chez toi (avec emojis), on détecte "nom_prenom" + "poste"
  const rows = tableFromAuto(values, ["nom_prenom", "poste"]);

  const employees = rows
    .map((r) => {
      const name = String(r.nom_prenom ?? r.nom_prenom_ ?? r.nom_prenom__ ?? r.nom_prenom___ ?? r.nom_prenom____ ?? r.nom_prenom_____ ?? r.nom_prenom______ ?? r.nom_prenom_______ ?? r.nom_prenom________ ?? r.nom_prenom_________ ?? r.nom_prenom__________ ?? r.nom_prenom___________ ?? r.nom_prenom____________ ?? r.nom_prenom_____________ ?? r.nom_prenom______________ ?? r.nom_prenom_______________ ?? r.nom_prenom________________ ?? r.nom_prenom_________________ ?? r.nom_prenom__________________ ?? r.nom_prenom___________________ ?? r.nom_prenom____________________ ?? r.nom_prenom_____________________ ?? r.nom_prenom______________________ ?? r.nom_prenom_______________________ ?? r.nom_prenom________________________ ?? r.nom_prenom_________________________ ?? r.nom_prenom__________________________ ?? r.nom_prenom___________________________ ?? r.nom_prenom____________________________ ?? r.nom_prenom_____________________________ ?? r.nom_prenom______________________________ ?? r.nom_prenom_______________________________ ?? r.nom_prenom________________________________ ?? r.nom_prenom_________________________________ ?? r.nom_prenom__________________________________ ?? r.nom_prenom___________________________________ ?? r.nom_prenom____________________________________ ?? r.nom_prenom_____________________________________ ?? r.nom_prenom______________________________________ ?? r.nom_prenom_______________________________________ ?? r.nom_prenom________________________________________ ?? r.nom_prenom_________________________________________ ?? r.nom_prenom__________________________________________ ?? r.nom_prenom___________________________________________ ?? r.nom_prenom____________________________________________ ?? r.nom_prenom_____________________________________________ ?? r.nom_prenom______________________________________________ ?? r.nom_prenom_______________________________________________ ?? r.nom_prenom________________________________________________ ?? r.nom_prenom_________________________________________________ ?? r.nom_prenom__________________________________________________ ?? r.nom_prenom___________________________________________________ ?? r.nom_prenom____________________________________________________ ?? r.nom_prenom_____________________________________________________ ?? r.nom_prenom______________________________________________________ ?? r.nom_prenom_______________________________________________________ ?? r.nom_prenom________________________________________________________ ?? r.nom_prenom_________________________________________________________ ?? r.nom_prenom__________________________________________________________ ?? r.nom_prenom___________________________________________________________ ?? r.nom_prenom____________________________________________________________ ?? r.nom_prenom_____________________________________________________________ ?? r.nom_prenom______________________________________________________________ ?? r.nom_prenom_______________________________________________________________ ?? r.nom_prenom________________________________________________________________ ?? r.nom_prenom_________________________________________________________________ ?? r.nom_prenom__________________________________________________________________ ?? r.nom_prenom___________________________________________________________________ ?? r.nom_prenom____________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________ ?? r.nom_prenom______________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________ ?? r.nom_prenom________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? r.nom_prenom________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ ?? ""
      ).trim();

      const role = String(r.poste ?? r.role ?? "").trim();
      const phone = String(r.telephone ?? r.tel ?? "").trim();

      const discount = discountByRole?.[role] ?? 0;

      return { name, role, discount, phone, avatar: "" };
    })
    .filter((e) => e.name);

  employees.sort((a, b) => a.name.localeCompare(b.name, "fr", { sensitivity: "base" }));
  return employees;
}

/* ------------------------------ META BUILD ------------------------------ */

async function buildMeta(sheets, ctx) {
  const roleCfg = await loadRoleConfig(sheets, ctx);
  const employeesFull = await loadEmployees(sheets, ctx, roleCfg.discountByRole);

  // Catalogue & entreprises (en dur)
  const catalogue = HARDCODED_CATALOGUE.slice();
  const enterprisesRows = HARDCODED_ENTERPRISES.slice();

  const employeeDiscounts = {};
  const directory = employeesFull.map((e) => ({
    name: e.name,
    role: e.role,
    avatar: e.avatar,
    phone: e.phone,
  }));

  for (const e of employeesFull) {
    employeeDiscounts[e.name] = { role: e.role, discount: e.discount };
  }

  const productsByCategory = {};
  const prices = {};
  for (const p of catalogue) {
    if (!productsByCategory[p.category]) productsByCategory[p.category] = [];
    productsByCategory[p.category].push(p.product);
    prices[p.product] = Number(p.price || 0);
  }

  const enterprises = {};
  for (const ent of enterprisesRows) {
    enterprises[ent.name] = { discount: Number(ent.discount || 0), phone: ent.phone || "", image: ent.image || "" };
  }

  const products = Object.values(productsByCategory).flat();

  return {
    version: "1.0.0",
    serverTime: isoNow(),
    currencySymbol: UI_CONFIG.currencySymbol,
    currencyCode: UI_CONFIG.currencyCode,

    employees: employeesFull.map((e) => e.name),
    directory,
    employeeDiscounts,

    products,
    productsByCategory,
    prices,
    enterprises,

    totals: { employees: employeesFull.length, products: products.length },

    ui: {
      adminPin: UI_CONFIG.adminPin,
      discordUsername: UI_CONFIG.discordUsername,
      discordAvatarUrl: UI_CONFIG.discordAvatarUrl,
    },
  };
}

function calcInvoiceTotals({ items, prices, discountActivated, enterpriseName, enterprises, employeeDiscountPct }) {
  const subtotal = items.reduce((s, it) => {
    const pu = Number(prices[it.desc] ?? 0);
    const qty = Math.floor(Number(it.qty) || 0);
    return s + pu * qty;
  }, 0);

  let discountPct = 0;
  let discountType = "Aucune";

  if (discountActivated) {
    if (enterpriseName && enterprises[enterpriseName]) {
      discountPct = Number(enterprises[enterpriseName].discount || 0);
      discountType = "Entreprise";
    } else {
      discountPct = Number(employeeDiscountPct || 0);
      discountType = "Employé";
    }
  }

  const discountAmount = +(subtotal * (discountPct / 100)).toFixed(2);
  const total = +(subtotal - discountAmount).toFixed(2);
  return { subtotal, discountPct, discountAmount, total, discountType };
}

/* --------------------------------- API --------------------------------- */

export async function GET() {
  return ok({ status: "ok", time: isoNow() });
}

export async function POST(request) {
  try {
    const body = await readJson(request);
    const action = String(body?.action || "getMeta");
    const data = body?.data || {};

    const sheets = await getSheets();
    const ctx = makeSheetCtx(sheets);

    if (action === "getMeta") {
      const meta = await buildMeta(sheets, ctx);
      return ok(meta);
    }

    const meta = await buildMeta(sheets, ctx);

    /* ------------------------------- FACTURES ------------------------------ */
    if (action === "sendFactures") {
      const employee = String(data.employee || "").trim();
      const invoiceNumber = String(data.invoiceNumber || "").trim();
      const enterprise = String(data.enterprise || "").trim();
      const customerName = String(data.customerName || "").trim();
      const employeeCard = toBool(data.employeeCard);
      const discountActivated = toBool(data.discountActivated);

      if (!employee || !meta.employees.includes(employee)) return bad("Employé invalide");
      if (!invoiceNumber || invoiceNumber.length < 3 || invoiceNumber.length > 40) return bad("Numéro facture invalide");

      const rawItems = Array.isArray(data.items) ? data.items : [];
      const items = rawItems
        .map((i) => ({
          desc: String(i.desc ?? i.name ?? "").trim(),
          qty: Math.floor(Number(i.qty ?? i.q ?? 0)),
        }))
        .filter((i) => i.desc && i.qty > 0);

      if (items.length === 0) return bad("Aucun article");
      for (const it of items) {
        if (!(it.desc in meta.prices)) return bad(`Produit invalide: ${it.desc}`);
      }

      const employeeDiscountPct = meta.employeeDiscounts?.[employee]?.discount ?? 0;
      const role = meta.employeeDiscounts?.[employee]?.role || "";

      const totals = calcInvoiceTotals({
        items,
        prices: meta.prices,
        discountActivated,
        enterpriseName: enterprise,
        enterprises: meta.enterprises,
        employeeDiscountPct,
      });

      const itemsDetails = items.map((i) => `${i.desc} (×${i.qty})`).join("; ");

      await ensureHeadersIfEmpty(sheets, ctx, "Factures", [
        "Date",
        "Employé",
        "Rôle",
        "N° Facture",
        "Entreprise",
        "Client",
        "Carte Employé",
        "Type Remise",
        "% Remise",
        "Sous-total",
        "Montant Remise",
        "Total",
        "Nb Articles",
        "Détails Articles",
        "Horodatage",
      ]);

      await sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: `'Factures'!A:O`,
        valueInputOption: "USER_ENTERED",
        requestBody: {
          values: [[
            todayFR(),
            employee,
            role,
            invoiceNumber,
            enterprise || "",
            customerName || "",
            employeeCard ? "Oui" : "Non",
            totals.discountType,
            totals.discountPct,
            totals.subtotal,
            totals.discountAmount,
            totals.total,
            items.length,
            itemsDetails,
            isoNow(),
          ]],
        },
      });

      await sendDiscordWebhook(WEBHOOKS.FACTURATION, {
        username: meta.ui?.discordUsername || "Secretaire Vespucci",
        avatar_url: meta.ui?.discordAvatarUrl || undefined,
        embeds: [{
          title: `🧾 Facture N°${invoiceNumber}`,
          description: `**Nouvelle facture générée - Esthétique Vespucci**`,
          color: 0x00b3ff,
          fields: [
            {
              name: "📋 Informations Générales",
              value: [
                `**Employé:** ${employee}`,
                `**Rôle:** ${role || "—"}`,
                `**Entreprise:** ${enterprise || "—"}`,
                `**Client:** ${customerName || "—"}`,
                `**Carte employé:** ${employeeCard ? "Oui" : "Non"}`,
              ].join("\n"),
              inline: false,
            },
            {
              name: "💰 Détails Financiers",
              value: [
                `**Sous-total:** ${meta.currencySymbol}${totals.subtotal.toFixed(2)}`,
                `**Réduction:** ${totals.discountPct}% (${meta.currencySymbol}${totals.discountAmount.toFixed(2)})`,
                `**Type réduction:** ${totals.discountType}`,
                `**Total final:** ${meta.currencySymbol}${totals.total.toFixed(2)}`,
              ].join("\n"),
              inline: false,
            },
            {
              name: "📜 Service effectué",
              value: items
                .map((i) => `• ${i.desc} ×${i.qty} - ${meta.currencySymbol}${(meta.prices[i.desc] || 0).toFixed(2)}`)
                .join("\n"),
              inline: false,
            },
          ],
          footer: { text: `Esthétique Vespucci - Facturation • ${todayFR()}` },
          timestamp: isoNow(),
        }],
      });

      return ok({
        subtotal: totals.subtotal,
        discountPct: totals.discountPct,
        discountType: totals.discountType,
        discountAmount: totals.discountAmount,
        total: totals.total,
      });
    }

    /* ---------------------------------- RH --------------------------------- */
    if (action === "sendHR") {
      const type = String(data.type || "").trim().toLowerCase();
      const initiatedBy = String(data.initiatedBy || data.employee || "").trim();
      const reason = String(data.reason || "").trim();
      const date = String(data.date || "").trim();
      const details = String(data.details || "").trim();

      if (!type || !initiatedBy || !reason || !date) return bad("Données incomplètes");
      if (!meta.employees.includes(initiatedBy)) return bad("Auteur invalide");

      // DEPENSE
      if (type === "depense") {
        const amount = toNumber(data.amount ?? 0);
        if (amount <= 0) return bad("Montant invalide");

        const role = meta.employeeDiscounts?.[initiatedBy]?.role || "Employé";
        const idFacture = makeDepenseId();

        await ensureHeadersIfEmpty(sheets, ctx, "Calculation", [
          "Date",
          "Nom & Prénom",
          "Poste",
          "ID Facture",
          "Entreprise",
          "Motifs",
          "Quantités",
          "Montant",
        ]);

        await sheets.spreadsheets.values.append({
          spreadsheetId: SHEET_ID,
          range: `'Calculation'!A:H`,
          valueInputOption: "USER_ENTERED",
          requestBody: {
            values: [[
              new Date(date).toLocaleDateString("fr-FR"),
              initiatedBy,
              role,
              idFacture,
              details || "",
              reason,
              1,
              amount,
            ]],
          },
        });

        await sendDiscordWebhook(WEBHOOKS.DEPENSE, {
          username: "Vespucci Direction",
          avatar_url: meta.ui?.discordAvatarUrl || undefined,
          embeds: [{
            title: "💸 Déclaration de Dépense",
            description: "Nouvelle dépense entreprise",
            color: 0x20c997,
            fields: [
              { name: "💰 Montant", value: `**${meta.currencySymbol}${amount.toFixed(2)}**`, inline: true },
              { name: "📅 Date effective", value: new Date(date).toLocaleDateString("fr-FR"), inline: true },
              { name: "🔄 Initié par", value: initiatedBy, inline: true },
              { name: "📝 Motif / Description", value: reason, inline: false },
              ...(details ? [{ name: "🏢 Entreprise / Fournisseur", value: details, inline: false }] : []),
            ],
            footer: { text: "Esthétique Vespucci - Direction" },
            timestamp: isoNow(),
          }],
        });

        return ok({});
      }

      // RH CLASSIQUE
      const employeeTarget = String(data.employeeTarget || data.employee || "").trim();
      if (!employeeTarget) return bad("Employé concerné manquant");

      await ensureHeadersIfEmpty(sheets, ctx, "RH", [
        "Date",
        "Type Action",
        "Employé",
        "Motif",
        "Date Effective",
        "Détails",
        "Initié par",
        "Horodatage",
      ]);

      await sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: `'RH'!A:H`,
        valueInputOption: "USER_ENTERED",
        requestBody: {
          values: [[
            todayFR(),
            type,
            employeeTarget,
            reason,
            new Date(date).toLocaleDateString("fr-FR"),
            details || "",
            initiatedBy,
            isoNow(),
          ]],
        },
      });

      const webhookMap = {
        recrutement: WEBHOOKS.RECRUTEMENT,
        convocation: WEBHOOKS.CONVOCATION,
        avertissement: WEBHOOKS.AVERTISSEMENT,
        licenciement: WEBHOOKS.LICENCIEMENT,
        demission: WEBHOOKS.DEMISSION,
      };

      const titles = {
        recrutement: { title: "➕ Recrutement", color: 0x2ecc71, desc: "Nouvelle embauche" },
        convocation: { title: "📋 Convocation", color: 0x3498db, desc: "Nouvelle convocation émise" },
        avertissement: { title: "⚠️ Avertissement", color: 0xf39c12, desc: "Nouvel avertissement émis" },
        licenciement: { title: "🔴 Licenciement", color: 0xe74c3c, desc: "Procédure de licenciement" },
        demission: { title: "📝 Démission", color: 0x9b59b6, desc: "Démission enregistrée" },
      };

      const t = titles[type] || { title: "Action RH", color: 0x777777, desc: "Action RH" };

      await sendDiscordWebhook(webhookMap[type], {
        username: "Vespucci Direction",
        avatar_url: meta.ui?.discordAvatarUrl || undefined,
        embeds: [{
          title: t.title,
          description: t.desc,
          color: t.color,
          fields: [
            { name: "👤 Employé concerné", value: `**${employeeTarget}**`, inline: true },
            { name: "📅 Date effective", value: new Date(date).toLocaleDateString("fr-FR"), inline: true },
            { name: "🔄 Initié par", value: initiatedBy, inline: true },
            { name: "📝 Motif / Description", value: reason, inline: false },
            ...(details ? [{ name: "📋 Détails supplémentaires", value: details, inline: false }] : []),
          ],
          footer: { text: "Esthétique Vespucci - Direction" },
          timestamp: isoNow(),
        }],
      });

      return ok({});
    }

    return bad("Action inconnue", 400);
  } catch (err) {
    console.error("API error:", err?.message || err);
    return bad(err?.message || String(err), 500);
  }
}
